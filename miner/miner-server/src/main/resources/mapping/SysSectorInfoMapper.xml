<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mei.hui.miner.mapper.SysSectorInfoMapper">
    
    <resultMap type="SysSectorInfo" id="SysSectorInfoResult">
        <result property="id"    column="id"    />
        <result property="minerId"    column="miner_id"    />
        <result property="hostname"    column="hostname"    />
        <result property="sectorNo"    column="sector_no"    />
        <result property="sectorSize"    column="sector_size"    />
        <result property="sectorStatus"    column="sector_status"    />
        <result property="sectorStart"    column="sector_start"    />
        <result property="sectorEnd" column="sector_end"/>
        <result property="sectorDuration"    column="sector_duration"    />
        <result property="time" column="time"/>
        <result property="status" column="status"/>
        <result property="createBy"    column="create_by"    />
        <result property="createTime"    column="create_time"    />
        <result property="updateBy"    column="update_by"    />
        <result property="updateTime"    column="update_time"    />
    </resultMap>

    <sql id="selectSysSectorInfoVo">
        select id, miner_id, hostname, sector_no, sector_size, sector_status, sector_start,sector_end, sector_duration,time,status, create_by, create_time, update_by, update_time from sys_sector_info
    </sql>

    <sql id="SysSectorInfoVo">
        select id, miner_id, hostname, sector_no, sector_size, sector_status, sector_start,sector_end, sector_duration,time,status, create_by, create_time, update_by, update_time from sys_sector_info
    </sql>

    <select id="selectSysSectorInfoList" parameterType="SysSectorInfo" resultMap="SysSectorInfoResult">
        <include refid="selectSysSectorInfoVo"/>
        <where>  
            <if test="minerId != null  and minerId != ''"> and miner_id = #{minerId}</if>
            <if test="hostname != null  and hostname != ''"> and hostname like concat('%', #{hostname}, '%')</if>
            <if test="sectorNo != null "> and sector_no = #{sectorNo}</if>
            <if test="sectorSize != null "> and sector_size = #{sectorSize}</if>
            <if test="sectorStatus != null "> and sector_status = #{sectorStatus}</if>
            <if test="sectorStart != null "> and sector_start = #{sectorStart}</if>
            <if test="sectorDuration != null "> and sector_duration = #{sectorDuration}</if>
        </where>
    </select>

    <select id="selectSysSectorInfoById" parameterType="Long" resultMap="SysSectorInfoResult">
        <include refid="selectSysSectorInfoVo"/>
        where id = #{id}
    </select>

    <select id="selectSysSectorInfoByMinerIdAndSectorNoAndStatus" parameterType="SysSectorInfo" resultMap="SysSectorInfoResult">
        <include refid="selectSysSectorInfoVo"/>
        where miner_id = #{minerId} and sector_no = #{sectorNo} and sector_status = #{sectorStatus}
    </select>

    <delete id="deleteSysSectorInfoById" parameterType="Long">
        delete from sys_sector_info where id = #{id}
    </delete>

    <delete id="deleteSysSectorInfoByIds" parameterType="String">
        delete from sys_sector_info where id in 
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <!--查询数据库里该miner_id、sector_no小于传过来的sector_status的值是否有进行中的状态-->
    <select id="selectSysSectorInfoByMinerIdAndSectorNoAndSectorAndLtStatus" parameterType="com.mei.hui.miner.entity.SysSectorInfo" resultMap="SysSectorInfoResult">
        <include refid="selectSysSectorInfoVo"/>
        <where>
            STATUS = 0
            <if test="minerId != null and minerId != ''">
                AND miner_id = #{minerId}
            </if>
            <if test="sectorNo != null">
                AND sector_no = #{sectorNo}
            </if>
            <if test="sectorStatus != null ">
                AND #{sectorStatus} > sector_status
            </if>
        </where>
    </select>

    <!--封装扇区有错误，重新封装时，删除以前的旧数据-->
    <delete id="deleteSysSectorInfoOld">
        DELETE
        FROM
            sys_sector_info
        <where>
            <if test="minerId != null and minerId != ''">
                miner_id = #{minerId}
            </if>
            <if test="sectorNo != null ">
                AND sector_no = #{sectorNo}
            </if>
            <if test="sectorStatus != null ">
                AND sector_status > #{sectorStatus}
            </if>
            AND sector_end IS NOT NULL
        </where>
    </delete>

    <!--查询sys_sector_info里的所有的封装时间总和-->
    <select id="selectSysSectorInfoSumSectorDuration" resultType="java.lang.Long">
        SELECT
        SUM(s.sector_duration)
        from
        sys_sector_info  s
        <where>
            <if test="minerId != null and minerId != ''">
                s.miner_id  = #{minerId}
            </if>
            <if test="sectorNo != null ">
                and s.sector_no = #{sectorNo}
            </if>
        </where>
    </select>

    <!--查询数据库里该miner_id、sector_no小于传过来的sector_status的值是否有进行中的状态，如果有，改成已完成-->
    <delete id="updateSysSectorInfoByMinerIdAndSectorNoAndSectorAndLtStatus">
        UPDATE sys_sector_info
        SET STATUS = 1
        <where>
            STATUS = 0
            <if test="minerId != null and minerId != ''">
                AND miner_id = #{minerId}
            </if>
            <if test="sectorNo != null ">
                AND sector_no = #{sectorNo}
            </if>
            <if test="sectorStatus != null ">
                AND #{sectorStatus} > sector_status
            </if>
        </where>
    </delete>


</mapper>