<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mei.hui.miner.mapper.FilBillMapper">

    <!--结果集一对多或多对多-->
    <resultMap id="resultBillMap" type="com.mei.hui.miner.entity.FilBill">
        <id column="id" property="id"/>
        <result column="miner_id" property="minerId"/>
        <result column="cid" property="cid"/>
        <result column="height" property="height"/>
        <result column="sender" property="sender"/>
        <result column="receiver" property="receiver"/>
        <result column="method" property="method"/>
        <result column="money" property="money"/>
        <result column="size_bytes" property="sizeBytes"/>
        <result column="nonce" property="nonce"/>
        <result column="gas_fee_cap" property="gasFeeCap"/>
        <result column="gas_premium" property="gasPremium"/>
        <result column="gas_limit" property="gasLimit"/>
        <result column="state_root" property="stateRoot"/>
        <result column="exit_code" property="exitCode"/>
        <result column="gas_used" property="gasUsed"/>
        <result column="parent_base_fee" property="parentBaseFee"/>
        <result column="base_fee_burn" property="baseFeeBurn"/>
        <result column="over_estimation_burn" property="overEstimationBurn"/>
        <result column="miner_penalty" property="minerPenalty"/>
        <result column="miner_tip" property="minerTip"/>
        <result column="refund" property="refund"/>
        <result column="gas_refund" property="gasRefund"/>
        <result column="gas_burned" property="gasBurned"/>
        <result column="date_time" property="dateTime"/>
        <result column="create_time" property="createTime"/>
        <!--<collection property="detailList"
                    ofType="com.mei.hui.miner.entity.FilBillDetail"
                    fetchType="lazy" select="findBillDetailList"
                    column="{billId = id}">
        </collection>-->
    </resultMap>

    <resultMap id="billDetailMap" type="com.mei.hui.miner.entity.FilBillDetail">
         <id column="id" property="id"/>
         <result column="bill_id" property="billId"/>
         <result column="sender" property="sender"/>
         <result column="receiver" property="receiver"/>
         <result column="money" property="money"/>
         <result column="type" property="type"/>
         <result column="create_time" property="createTime"/>
    </resultMap>


    <!--账单方法下拉列表-->
    <select id="selectFilBillMethodList" resultType="java.lang.String">
        SELECT
        b.method
        FROM
        fil_bill b
        <where>
            <if test="minerId != null and minerId != ''">
                b.miner_id = #{minerId}
            </if>
            <if test="subAccount != null and subAccount != ''">
                AND (
                b.sender = #{subAccount}
                OR b.receiver = #{subAccount}
                )
            </if>
            <if test="startDate != null and startDate != null">
                AND b.date_time >= #{startDate}
            </if>
            <if test="endDate != null and endDate != ''">
                AND #{endDate} >= b.date_time
            </if>
        </where>
        GROUP BY b.method
    </select>

    <!--分页查询账单消息列表-->
    <select id="selectFilBillPage" resultType="com.mei.hui.miner.feign.vo.FilBillVO">
        select b.date_time dateTime,b.cid,b.method,t.money,t.type,t.sender,t.receiver
        from
        fil_bill_transactions t
        LEFT JOIN
        fil_bill b
        on t.fil_bill_id = b.id
        <where>
            <if test="minerId != null and minerId != ''">
                b.miner_id = #{minerId}
            </if>
            <if test="startDate != null and startDate != null">
                AND b.date_time >= #{startDate}
            </if>
            <if test="endDate != null and endDate != ''">
                AND #{endDate} >= b.date_time
            </if>
            <if test="method != null and method != ''">
                and b.method = #{method}
            </if>
            <choose>
                <when test="type != null">
                    <if test="type == 0">
                        and t.sender = #{subAccount}
                    </if>
                    <if test="type == 1">
                        and t.receiver = #{subAccount}
                    </if>
                </when>
                <otherwise>
                    and (t.sender = #{subAccount}
                    OR t.receiver = #{subAccount})
                </otherwise>
            </choose>
        </where>
    </select>

    <!--查询方法、金额汇总信息list-->
    <select id="selectBillMethodMoneyList" resultType="com.mei.hui.miner.feign.vo.BillMethodMoneyVO">
        SELECT
            b.method,
            SUM(b.money) money
        FROM
            fil_bill_transactions t
        LEFT JOIN fil_bill b ON t.fil_bill_id = b.id
        <where>
            <if test="minerId != null and minerId != ''">
                b.miner_id = #{minerId}
            </if>
            <if test="startDate != null and startDate != null">
                AND b.date_time >= #{startDate}
            </if>
            <if test="endDate != null and endDate != ''">
                AND #{endDate} >= b.date_time
            </if>
            <if test="subAccount != null and subAccount != ''">
                <if test="type == 'in'">
                    AND t.receiver = #{subAccount}
                </if>
                <if test="type == 'out'">
                    AND t.sender = #{subAccount}
                </if>
            </if>
        </where>
        GROUP BY
            b.method
    </select>

    <!--分页查询日账单列表-->
    <select id="selectFilBillDayAggPage" resultType="com.mei.hui.miner.feign.vo.FilBillDayAggVO">
        SELECT
        id,date,in_money inMoney,out_money outMoney,balance
        FROM
        fil_bill_day_agg
        <where>
            <if test="minerId != null and minerId != ''">
              miner_id = #{minerId}
            </if>
            <if test="startDate != null and startDate != null">
                AND date >= #{startDate}
            </if>
            <if test="endDate != null and endDate != ''">
                AND #{endDate} >= date
            </if>
        </where>
        ORDER BY date DESC
    </select>

    <!--查询账单月汇总转账收支-->
    <select id="selectFilBillTransferDateAgg" resultType="java.math.BigDecimal">
        SELECT
        SUM(t.money)
        FROM
        fil_bill_transactions t
        LEFT JOIN fil_bill b ON t.fil_bill_id = b.id
        <where>
            <if test="minerId != null and minerId != ''">
                b.miner_id = #{minerId}
            </if>
            <if test="startDate != null and startDate != null">
                AND b.date_time >= #{startDate}
            </if>
            <if test="endDate != null and endDate != ''">
                AND #{endDate} >= b.date_time
            </if>
            <if test="outsideType != null">
                and t.outside_type = #{outsideType}
            </if>
            and b.method in ('Send','Propose','ReportConsensusFault')
            and b.type = 0
            and t.type = 2
            and t.transaction_type = 1
        </where>
    </select>

    <!--查询账单按照日期范围汇总矿工手续费、燃烧手续费支出-->
    <select id="selectFilBillOutFeeDateAgg" resultType="java.math.BigDecimal">
        SELECT
        SUM(t.money)
        FROM
        fil_bill_transactions t
        LEFT JOIN fil_bill b ON t.fil_bill_id = b.id
        <where>
            <if test="minerId != null and minerId != ''">
                b.miner_id = #{minerId}
            </if>
            <if test="startDate != null and startDate != null">
                AND b.date_time >= #{startDate}
            </if>
            <if test="endDate != null and endDate != ''">
                AND #{endDate} >= b.date_time
            </if>
            <if test="type != null">
                and t.type = #{type}
            </if>
            and b.type = 0
        </where>
    </select>

    <!--查询账单按照日期范围汇总所有外部交易支出-->
    <select id="selectFilBillOutAllDateAgg" resultType="java.math.BigDecimal">
        SELECT
        SUM(t.money)
        FROM
        fil_bill_transactions t
        LEFT JOIN fil_bill b ON t.fil_bill_id = b.id
        <where>
            <if test="minerId != null and minerId != ''">
                b.miner_id = #{minerId}
            </if>
            <if test="startDate != null and startDate != null">
                AND b.date_time >= #{startDate}
            </if>
            <if test="endDate != null and endDate != ''">
                AND #{endDate} >= b.date_time
            </if>
            and b.type = 0
            and t.type = 4
        </where>
    </select>

    <!--查询账单月汇总区块奖励收入-->
    <select id="selectFilBillinBlockAwardDateAgg" resultType="java.math.BigDecimal">
        SELECT
        SUM(t.money)
        FROM
        fil_bill_transactions t
        LEFT JOIN fil_bill b ON t.fil_bill_id = b.id
        <where>
            <if test="minerId != null and minerId != ''">
                b.miner_id = #{minerId}
            </if>
            <if test="startDate != null and startDate != null">
                AND b.date_time >= #{startDate}
            </if>
            <if test="endDate != null and endDate != ''">
                AND #{endDate} >= b.date_time
            </if>
            and b.type = 1
        </where>
    </select>

    <!--分页查询日账单详情列表-->
    <select id="selectFilBillTransactionsPage" resultType="com.mei.hui.miner.feign.vo.FilBillVO">
        SELECT
        b.date_time,b.cid,t.sender,t.receiver,t.money,t.type,t.outside_type
        FROM
        fil_bill_transactions t
        LEFT JOIN fil_bill b ON t.fil_bill_id = b.id
        <where>
            <if test="minerId != null and minerId != ''">
                b.miner_id = #{minerId}
            </if>
            <if test="startDate != null and startDate != null">
                AND b.date_time >= #{startDate}
            </if>
            <if test="endDate != null and endDate != ''">
                AND #{endDate} >= b.date_time
            </if>
            <if test="outsideType != null">
                and t.outside_type = #{outsideType}
            </if>
            <choose>
                <when test="type != null">
                    <if test="type == 0">
                        and b.type = 0 and t.type = 0
                    </if>
                    <if test="type == 1">
                        and b.type = 0 and t.type = 1
                    </if>
                    <if test="type == 2">
                        and b.type = 0 and t.type = 2 and t.transaction_type = 1
                    </if>
                    <if test="type == 3">
                        and b.type = 1 and t.type = 3 and t.transaction_type = 1
                    </if>
                    <if test="type == 4">
                        and b.type = 0 and t.type = 4 and t.transaction_type = 1
                    </if>
                </when>
                <otherwise>

                </otherwise>
            </choose>
        </where>
    </select>

    <!--FIL币账单消息每天汇总收支-->
    <select id="selectFilBillTransactionsMoney" resultType="com.mei.hui.miner.entity.FilBillTransactions">
        SELECT
        SUM(t.money) money,t.outside_type outsideType
        FROM
        fil_bill_transactions t
        LEFT JOIN fil_bill b ON t.fil_bill_id = b.id
        <where>
            <if test="minerId != null and minerId != ''">
                b.miner_id = #{minerId}
            </if>
            <if test="startDate != null and startDate != null">
                AND b.date_time >= #{startDate}
            </if>
            <if test="endDate != null and endDate != ''">
                AND #{endDate} >= b.date_time
            </if>
            GROUP BY t.outside_type
        </where>
    </select>

</mapper>
